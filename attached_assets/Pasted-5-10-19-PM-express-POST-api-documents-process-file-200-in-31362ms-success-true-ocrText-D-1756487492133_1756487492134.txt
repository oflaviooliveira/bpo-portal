5:10:19 PM [express] POST /api/documents/process-file 200 in 31362ms :: {"success":true,"ocrText":"D‚Ä¶
üîç Processando arquivo para preview: Compra Pneus.pdf
üìÑ Iniciando extra√ß√£o de texto PDF: uploads/d0f5d8dfe2d21e20e5c51a23411490b1
‚úÖ Extra√ß√£o nativa bem-sucedida: 2342 caracteres
ü§ñ Analisando documento com IA: Compra Pneus.pdf
üìù Texto extra√≠do (2342 chars): DANFE
Documento Auxiliar da 
Nota Fiscal Eletr√¥nica
AV MARIA DO CARMO, 1571
POSTO LAVA TUCUNS
CRUZ / CE
62595-000
(88) 9729-5739 - 
0 - ENTRADA
1 - SA√çDA
CHAVE DE ACESSO
N¬∫ 645   
S√©rie 1 
Consulta de...
üìã Detectada nota fiscal - usando analisador especializado
üîÑ Usando AI Multi-Provider para an√°lise...
üìã Documento classificado como: DANFE (57.5% confian√ßa)
üîç Indicadores: Keyword: DANFE, Keyword: Nota Fiscal Eletr√¥nica, Keyword: CNPJ, Keyword: Chave de Acesso, Keyword: ICMS, Keyword: CFOP, Keyword: NCM, Pattern: \d{4}\s\d{4}\s\d{4}\s\d{4}\s\d{4}\s\d{4}\s\d{4}\s\d{4}\s\d{4}\s\d{4}\s\d{4}
üìã Documento complexo detectado (DANFE) - priorizando OpenAI
ü§ñ Tentando an√°lise com openai...
üîó OpenAI API Request - Model: gpt-4o-mini
üí∞ OpenAI Expected Cost: $0.375/1k tokens
ü§ñ OpenAI Response (gpt-4o-mini): {
  "valor": "VALOR TOTAL DA NOTA",
  "fornecedor": "ROBSON PNEUS E AUTOPECAS LTDA",
  "cnpj_emitente": "95.001.834/0001-34",
  "data_emissao": "19/07/2025",
  "data_saida": "19/07/2025",
  "data_vencimento": "FATURA",
  "descricao": "Revenda de mercadorias com ST",
  "categoria": "COMP",
  "documento": "N¬∫ 645 S√©rie 1",
  "confidence": "alta"
}
‚ö†Ô∏è Schema validation strict failed for openai, trying flexible validation...
üîß GLM response auto-corrected: {
  valor: 'R$ VALOR TOTAL DA NOTA',
  fornecedor: 'ROBSON PNEUS E AUTOPECAS LTDA',
  cnpj_emitente: '95.001.834/0001-34',
  data_emissao: '19/07/2025',
  data_saida: '19/07/2025',
  data_vencimento: 'FATURA',
  descricao: 'Revenda de mercadorias com ST',
  categoria: 'COMP',
  documento: 'N¬∫ 645 S√©rie 1',
  confidence: 85,
  centro_custo: 'GERAL'
}
‚ùå Both validation attempts failed for openai: ZodError: [
  {
    "validation": "regex",
    "code": "invalid_string",
    "message": "Formato de valor inv√°lido. Use: R$ X.XXX,XX",
    "path": [
      "valor"
    ]
  },
  {
    "validation": "regex",
    "code": "invalid_string",
    "message": "Data deve estar no formato DD/MM/AAAA",
    "path": [
      "data_vencimento"
    ]
  }
]
    at get error [as error] (file:///home/runner/workspace/node_modules/zod/lib/index.mjs:587:31)
    at ZodObject.parse (file:///home/runner/workspace/node_modules/zod/lib/index.mjs:663:22)
    at AIMultiProvider.analyzeDocument (/home/runner/workspace/server/ai-multi-provider.ts:652:60)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async DocumentAnalyzer.analyzeDocument (/home/runner/workspace/server/ai/document-analyzer.ts:82:24)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:276:22) {
  issues: [
    {
      validation: 'regex',
      code: 'invalid_string',
      message: 'Formato de valor inv√°lido. Use: R$ X.XXX,XX',
      path: [Array]
    },
    {
      validation: 'regex',
      code: 'invalid_string',
      message: 'Data deve estar no formato DD/MM/AAAA',
      path: [Array]
    }
  ],
  addIssue: [Function (anonymous)],
  addIssues: [Function (anonymous)],
  errors: [
    {
      validation: 'regex',
      code: 'invalid_string',
      message: 'Formato de valor inv√°lido. Use: R$ X.XXX,XX',
      path: [Array]
    },
    {
      validation: 'regex',
      code: 'invalid_string',
      message: 'Data deve estar no formato DD/MM/AAAA',
      path: [Array]
    }
  ]
}
‚ö†Ô∏è Provider openai kept ONLINE (format error, recoverable)
ü§ñ Tentando an√°lise com glm (fallback)...
üîó GLM API Request - Model: glm-4.5
üí∞ GLM Expected Cost: $1.4/1k tokens
üìù GLM Full prompt length: 2816 chars
üìù GLM Prompt preview: Voc√™ √© um especialista em an√°lise de DANFE (Documento Auxiliar da Nota Fiscal Eletr√¥nica) brasileira.


ARQUIVO: Compra Pneus.pdf
TEXTO OCR: DANFE
Documento Auxiliar da 
Nota Fiscal Eletr√¥nica
AV MARIA DO CARMO, 1571
POSTO LAVA TUCUNS
CRUZ / CE
62595-000
(88) 9729-5739 - 
0 - ENTRADA
1 - SA√çDA
CHAVE...
üìù GLM Request payload size: 223 chars
‚è∞ Starting GLM request with 45s timeout...
üîç GLM Response status: 200 (16863ms)
üìä GLM Response headers: {"connection":"keep-alive","content-encoding":"gzip","content-type":"application/json; charset=UTF-8","date":"Fri, 29 Aug 2025 17:11:25 GMT","server":"ZenZGA/2.4","strict-transport-security":"max-age=31536000; includeSubDomains","transfer-encoding":"chunked","vary":"Accept-Encoding, Origin, Access-Control-Request-Method, Access-Control-Request-Headers, Origin, Access-Control-Request-Method, Access-Control-Request-Headers","x-log-id":"20250830011109956aa5dd62d74d3d"}
üì¶ GLM Raw response structure: [ 'choices', 'created', 'id', 'model', 'request_id', 'usage' ]
ü§ñ GLM Response (glm-4.5): {
  "valor": null,
  "fornecedor": "ROBSON PNEUS E AUTOPECAS LTDA",
  "data_pagamento": null,
  "data_vencimento": null,
  "descricao": "Revenda de mercadorias com ST",
  "categoria": null,
  "centro_custo": "COMP",
  "documento": "DANFE N¬∫ 645 S√©rie 1",
  "confidence": 30
}
üìè GLM Response length: 275 chars
‚ö†Ô∏è Schema validation strict failed for glm, trying flexible validation...
üîß GLM response auto-corrected: {
  fornecedor: 'ROBSON PNEUS E AUTOPECAS LTDA',
  descricao: 'Revenda de mercadorias com ST',
  centro_custo: 'COMP',
  documento: 'DANFE N¬∫ 645 S√©rie 1',
  confidence: 30,
  categoria: 'Outros'
}
‚ùå Both validation attempts failed for glm: ZodError: [
  {
    "code": "invalid_type",
    "expected": "string",
    "received": "undefined",
    "path": [
      "valor"
    ],
    "message": "Required"
  }
]
    at get error [as error] (file:///home/runner/workspace/node_modules/zod/lib/index.mjs:587:31)
    at ZodObject.parse (file:///home/runner/workspace/node_modules/zod/lib/index.mjs:663:22)
    at AIMultiProvider.analyzeDocument (/home/runner/workspace/server/ai-multi-provider.ts:652:60)
    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)
    at async DocumentAnalyzer.analyzeDocument (/home/runner/workspace/server/ai/document-analyzer.ts:82:24)
    at async <anonymous> (/home/runner/workspace/server/routes.ts:276:22) {
  issues: [
    {
      code: 'invalid_type',
      expected: 'string',
      received: 'undefined',
      path: [Array],
      message: 'Required'
    }
  ],
  addIssue: [Function (anonymous)],
  addIssues: [Function (anonymous)],
  errors: [
    {
      code: 'invalid_type',
      expected: 'string',
      received: 'undefined',
      path: [Array],
      message: 'Required'
    }
  ]
}
‚ö†Ô∏è Provider glm kept ONLINE (format error, recoverable)
‚ùå Erro na an√°lise com IA: Error: Todos os provedores de IA falharam. √öltimo erro: [
  {
    "code": "invalid_type",
    "expected": "string",
    "received": "null",
    "path": [
      "valor"
    ],
    "message": "Expected string, received null"
  },
  {
    "code": "invalid_type",
    "expected": "string",
    "received": "null",
    "path": [
      "data_pagamento"
    ],
    "message": "Expected string, received null"
  },
  {
    "code": "invalid_type",
    "expected": "string",
    "received": "null",
    "path": [
      "data_vencimento"
    ],
    "message": "Expected string, received null"
  },
  {
    "code": "invalid_type",
    "expected": "string",
    "received": "null",
    "path": [
      "categoria"
    ],
    "message": "Expected string, received null"
  }
]
‚ö†Ô∏è IA n√£o retornou dados v√°lidos: {
  success: false,
  confidence: 0,
  error: 'Erro na an√°lise: Error: Todos os provedores de IA falharam. √öltimo erro: [\n' +
    '  {\n' +
    '    "code": "invalid_type",\n' +
    '    "expected": "string",\n' +
    '    "received": "null",\n' +
    '    "path": [\n' +
    '      "valor"\n' +
    '    ],\n' +
    '    "message": "Expected string, received null"\n' +
    '  },\n' +
    '  {\n' +
    '    "code": "invalid_type",\n' +
    '    "expected": "string",\n' +
    '    "received": "null",\n' +
    '    "path": [\n' +
    '      "data_pagamento"\n' +
    '    ],\n' +
    '    "message": "Expected string, received null"\n' +
    '  },\n' +
    '  {\n' +
    '    "code": "invalid_type",\n' +
    '    "expected": "string",\n' +
    '    "received": "null",\n' +
    '    "path": [\n' +
    '      "data_vencimento"\n' +
    '    ],\n' +
    '    "message": "Expected string, received null"\n' +
    '  },\n' +
    '  {\n' +
    '    "code": "invalid_type",\n' +
    '    "expected": "string",\n' +
    '    "received": "null",\n' +
    '    "path": [\n' +
    '      "categoria"\n' +
    '    ],\n' +
    '    "message": "Expected string, received null"\n' +
    '  }\n' +
    ']'
}
5:11:25 PM [express] POST /api/documents/process-file 200 in 20461ms :: {"success":true,"ocrText":"D‚Ä¶